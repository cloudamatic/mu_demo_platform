---
appname: demo
parameters:
- name: ami
  required: false
  default: 'ami-02e98f78'
loadbalancers:
# - name: gitlab-lb
#   classic: true
#   vpc:
#     subnets:
#     - subnet_name: ryan_public
#   healthcheck:
#     target: HTTP:80/users/sign_in
#     timeout: 2
#     interval: 5
#     unhealthy-threshold: 2
#     healthy-threshold: 2
#   listeners:
#   - lb-port: 22
#     lb-protocol: TCP
#     instance-port: 22
#     instance-protocol: TCP
#   - lb-port: 443
#     lb-protocol: HTTPS
#     instance-port: 80
#     instance-protocol: HTTP
#     ssl-certificate-name: "*.egt-labs.com"
#   ingress_rules:
#   - port: 443
#     hosts:
#     - 0.0.0.0/0
#   - port: 22
#     hosts:
#     - 0.0.0.0/0
loadbalancers:
- name: gitlab-lb
  classic: true
  vpc:
    vpc_id: vpc-4820b030
  ingress_rules:
  - port: 443
    hosts:
    - 0.0.0.0/0
  - port: 22
    hosts:
    - 0.0.0.0/0
  healthcheck:
    target: HTTP:80/users/sign_in
    timeout: 2
    interval: 5
    unhealthy-threshold: 2
    healthy-threshold: 2
  listeners:
  - lb-port: 22
    lb-protocol: TCP
    instance-port: 22
    instance-protocol: TCP
  - lb-port: 443
    lb-protocol: HTTPS
    instance-port: 80
    instance-protocol: HTTP
    ssl-certificate-name: "*.egt-labs.com"

server_pools:
  - name: gitlab_asg
    min-size: 1
    max-size: 1
    skipinitialupdates: true
    loadbalancers:
    - concurrent-load-balancer: 'gitlab-lb'
    vpc:
      subnet_pref: private
      vpc_id: vpc-4820b030
    ingress_rules:
      - 
        port: 80
        hosts: 
          - "0.0.0.0/0"
    run_list:
    - recipe[demo_gitlab]
    - recipe[demo_gitlab::gitlab_runner]
    dependencies:
    - name: 'gitlab-lb'
      type: 'loadbalancer'

    basis:
      launch-config:
        name: 'gitlab_launc_config'
        size: t2.large
        ami-id: <%= ami %>
        iam-policies:
        - GitlabEc2GodMode:
            Version: '2012-10-17'
            Statement:
            - Effect: Allow
              Action:
                - "*"
              Resource:
                - "*"

